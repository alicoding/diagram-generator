{% if flow and flow.metadata.config %}
---
config:
{{ flow.metadata.config | to_yaml | indent(2, true) }}
---
{% endif %}
{% import 'theme.j2' as theme_macros %}
{{ theme_macros.render_theme(config) }}
graph TB


    %% Recursive Group Rendering Macro
    {% macro render_group(node, level=0) %}
        {% for child_key, child_node in node.children.items() %}
            subgraph {{ child_key }}["{{ child_node.name }}"]
                direction TB
                {{ render_group(child_node, level + 1) }}
            end
        {% endfor %}

        {% for comp in node.node_components %}
            {% set styleClass = comp.metadata.style if comp.metadata.style else "" %}
            {{ comp.id }}["{{ comp.name }}<br/>{{ comp.metadata.participant_name if comp.metadata.participant_name else '' }}"]{% if styleClass %}:::{{ styleClass }}{% endif %}
        {% endfor %}
    {% endmacro %}

    %% Render Hierarchy
    {{ render_group(hierarchy) }}

    %% Render Flow Connections
    {% if flow %}
        {% for step in flow.steps %}
            {% if step.metadata.type == 'note' %}
                %% Notes in Flowchart are tricky. We can use a distinct node shape.
                %% Or attach to edge if Mermaid supported it nicely.
                %% For now, skip or render as a comment/node?
                %% Let's render as a distinctive node.
                {{ step.source_id }}[/"{{ step.description }}"/]:::note
                {% if step.source_id != 'NOTE_ANCHOR' %}
                    {{ step.source_id }} -.- {{ step.metadata.position }}
                {% endif %}
            {% else %}
                {% if step.is_dashed %}
                    {% set arrow = "-.->" %}
                {% else %}
                    {% set arrow = "-->" %}
                {% endif %}

                {% if step.description %}
                    {{ step.source_id }} {{ arrow }}|{{ step.description }}| {{ step.target_id }}
                {% else %}
                    {{ step.source_id }} {{ arrow }} {{ step.target_id }}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% else %}
        {% for rel in relationships %}
            {{ rel.source_id }} --> {{ rel.target_id }}
        {% endfor %}
    {% endif %}

    classDef note fill:#fff5ad,stroke:#d9b805,stroke-width:1px,border-style:dashed;
    
    %% Custom Styles
    {% for style_name, style_def in styles.items() %}
    classDef {{ style_name }} {{ style_def }}
    {% endfor %}
